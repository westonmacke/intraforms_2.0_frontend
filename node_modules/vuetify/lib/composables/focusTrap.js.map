{"version":3,"file":"focusTrap.js","names":["nextTick","onBeforeUnmount","toRef","toValue","watch","focusableChildren","IN_BROWSER","propsFactory","makeFocusTrapProps","retainFocus","Boolean","captureFocus","disableInitialFocus","registry","Map","onKeydown","e","activeElement","document","key","parentTraps","Array","from","values","filter","_ref","isActive","contentEl","value","contains","map","x","closestTrap","currentParent","parentElement","includes","focusable","tabIndex","length","active","classList","preventDefault","firstElement","lastElement","shiftKey","focus","useFocusTrap","props","_ref2","localTop","activatorEl","trapId","Symbol","val","set","delete","immediate","focusTrapSuppressed","focusTrapSuppressionTimeout","onPointerdown","window","setTimeout","captureOnFocus","before","relatedTarget","after","target","removeEventListener","captureOnKeydown","allFocusableElements","documentElement","at","shouldCapture","addEventListener","once","clearTimeout"],"sources":["../../src/composables/focusTrap.ts"],"sourcesContent":["// Utilities\nimport { nextTick, onBeforeUnmount, toRef, toValue, watch } from 'vue'\nimport { focusableChildren, IN_BROWSER, propsFactory } from '@/util'\n\n// Types\nimport type { Ref } from 'vue'\n\n// Types\nexport interface FocusTrapProps {\n  retainFocus: boolean\n  captureFocus: boolean\n  disableInitialFocus?: boolean\n}\n\n// Composables\nexport const makeFocusTrapProps = propsFactory({\n  retainFocus: Boolean,\n  captureFocus: Boolean,\n  /** @deprecated */\n  disableInitialFocus: Boolean,\n}, 'focusTrap')\n\nconst registry = new Map<symbol, {\n  isActive: Ref<boolean>\n  contentEl: Ref<HTMLElement | undefined>\n}>()\n\nfunction onKeydown (e: KeyboardEvent) {\n  const activeElement = document.activeElement as HTMLElement | null\n  if (e.key !== 'Tab' || !activeElement) return\n\n  const parentTraps = Array.from(registry.values())\n    .filter(({ isActive, contentEl }) => isActive.value && contentEl.value?.contains(activeElement))\n    .map(x => x.contentEl.value)\n\n  let closestTrap\n  let currentParent = activeElement.parentElement\n  while (currentParent) {\n    if (parentTraps.includes(currentParent)) {\n      closestTrap = currentParent\n      break\n    }\n    currentParent = currentParent.parentElement\n  }\n\n  if (!closestTrap) return\n\n  const focusable = focusableChildren(closestTrap)\n    // excluding VListItems with tabindex=\"-2\"\n    .filter(x => x.tabIndex >= 0)\n\n  if (!focusable.length) return\n\n  const active = document.activeElement as HTMLElement | null\n  if (\n    focusable.length === 1 &&\n    focusable[0].classList.contains('v-list') &&\n    focusable[0].contains(active)\n  ) {\n    e.preventDefault()\n    return\n  }\n\n  const firstElement = focusable[0]\n  const lastElement = focusable[focusable.length - 1]\n\n  if (\n    e.shiftKey &&\n    (\n      active === firstElement ||\n      (firstElement.classList.contains('v-list') && firstElement.contains(active))\n    )\n  ) {\n    e.preventDefault()\n    lastElement.focus()\n  }\n\n  if (\n    !e.shiftKey &&\n    (\n      active === lastElement ||\n      (lastElement.classList.contains('v-list') && lastElement.contains(active))\n    )\n  ) {\n    e.preventDefault()\n    firstElement.focus()\n  }\n}\n\nexport function useFocusTrap (\n  props: FocusTrapProps,\n  { isActive, localTop, activatorEl, contentEl }: {\n    isActive: Ref<boolean>\n    localTop: Readonly<Ref<boolean>>\n    activatorEl?: Readonly<Ref<HTMLElement | undefined>>\n    contentEl: Readonly<Ref<HTMLElement | undefined>>\n  }\n) {\n  const trapId = Symbol('trap')\n  watch(() => props.retainFocus, val => {\n    if (val) {\n      registry.set(trapId, { isActive, contentEl })\n    } else {\n      registry.delete(trapId)\n    }\n  }, { immediate: true })\n\n  let focusTrapSuppressed = false\n  let focusTrapSuppressionTimeout = -1\n\n  async function onPointerdown () {\n    focusTrapSuppressed = true\n    focusTrapSuppressionTimeout = window.setTimeout(() => {\n      focusTrapSuppressed = false\n    }, 100)\n  }\n\n  async function captureOnFocus (e: FocusEvent) {\n    const before = e.relatedTarget as HTMLElement | null\n    const after = e.target as HTMLElement | null\n\n    document.removeEventListener('pointerdown', onPointerdown)\n    document.removeEventListener('keydown', captureOnKeydown)\n\n    await nextTick()\n\n    if (\n      isActive.value &&\n      !focusTrapSuppressed &&\n      before !== after &&\n      contentEl.value &&\n      // We're the menu without open submenus or overlays\n      toValue(localTop) &&\n      // It isn't the document or the container body\n      ![document, contentEl.value].includes(after!) &&\n      // It isn't inside the container body\n      !contentEl.value.contains(after)\n    ) {\n      const focusable = focusableChildren(contentEl.value)\n      focusable[0]?.focus()\n    }\n  }\n\n  function captureOnKeydown (e: KeyboardEvent) {\n    if (e.key !== 'Tab') return\n    document.removeEventListener('keydown', captureOnKeydown)\n\n    if (\n      isActive.value &&\n      contentEl.value &&\n      e.target &&\n      !contentEl.value.contains(e.target as Element)\n    ) {\n      const allFocusableElements = focusableChildren(document.documentElement)\n\n      if (\n        (e.shiftKey && e.target === allFocusableElements.at(0)) ||\n        (!e.shiftKey && e.target === allFocusableElements.at(-1))\n      ) {\n        const focusable = focusableChildren(contentEl.value)\n        if (focusable.length > 0) {\n          e.preventDefault()\n          focusable[0].focus()\n        }\n      }\n    }\n  }\n\n  const shouldCapture = toRef(() => isActive.value && props.captureFocus && !props.disableInitialFocus)\n\n  IN_BROWSER && watch(shouldCapture, val => {\n    if (val) {\n      document.addEventListener('pointerdown', onPointerdown)\n      document.addEventListener('focusin', captureOnFocus, { once: true })\n      document.addEventListener('keydown', captureOnKeydown)\n    } else {\n      document.removeEventListener('pointerdown', onPointerdown)\n      document.removeEventListener('focusin', captureOnFocus)\n      document.removeEventListener('keydown', captureOnKeydown)\n    }\n  }, { immediate: true })\n\n  onBeforeUnmount(() => {\n    clearTimeout(focusTrapSuppressionTimeout)\n    document.removeEventListener('pointerdown', onPointerdown)\n    document.removeEventListener('focusin', captureOnFocus)\n    document.removeEventListener('keydown', captureOnKeydown)\n  })\n\n  IN_BROWSER && document.addEventListener('keydown', onKeydown)\n}\n"],"mappings":"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","ignoreList":[]}